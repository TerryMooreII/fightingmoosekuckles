<!doctype html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Fighting Moose Knuckles Hockey Club</title>
  <meta name="description" content="Gorilla's In The Mist beer league hockey club">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Fighting Moose Knuckles">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">

  <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <!-- Place favicon.ico in the root directory -->

  <meta name="theme-color" content="#fafafa">
  <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
  <link
  rel="stylesheet"
  href="https://unpkg.com/@tailwindcss/typography@0.2.x/dist/typography.min.css"
/>
</head>

<body class="bg-gray-100">
  <div class="flex justify-center container p-2 mx-auto">
    <div class="mt-8">
      <div class="items-center lg:flex flex flex-col">
        <div>
          <img class="w-32 mx-auto" src="assets/logo-white.png" alt="Fighting Moose Knuckles">
        </div>
        <div class="lg:ml-8 mt-4 lg:mt-0">
          <h1 class="lg:text-6xl text-2xl lg:text-left text-center">Fighting Moose Knuckles Hockey Club</h1>
          <!-- <h2 class="lg:text-2xl text-xl mt-2 lg:tracking-widest lg:text-left text-center">Just a Bunch of Beer League Knuckledraggers</h2> -->
        </div>        
      </div>
      <h3 class="text-center text-xl mt-3">Who's got beer this week?</h3>
      <div id="app" class="flex flex-col lg:flex-row w-full flex-wrap p-4 items-center justify-center lg:px-28"></div>
    </div>
  </div>
  <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID. -->
  <!-- <script type="javascript">
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-199574478-Y', 'auto'); ga('set', 'anonymizeIp', true); ga('set', 'transport', 'beacon'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async></script> -->

  <script>
    const teamid = "4112";

const url = `https://apps.daysmartrecreation.com/dash/jsonapi/api/v1/teams/${teamid}?cache[save]=false&include=events.eventType,events.homeTeam,events.visitingTeam,events.resource.facility,events.resourceArea,events.comments,league.playoffEvents.eventType,league.playoffEvents.homeTeam,league.playoffEvents.visitingTeam,league.playoffEvents.resource.facility,league.playoffEvents.resourceArea,league.playoffEvents.comments,league.programType,product.locations,programType,season,skillLevel,ageRange,sport&company=polarice`;

const sheetsUrl =
  "https://docs.google.com/spreadsheets/d/10yet2waUUOQmNdMW7mH1nBQC4Ue6_piqAdMQh5HjDys/gviz/tq?tqx=out:html&tq&gid=0";

const getData = async () => {
  const response = await fetch(url);
  return await response.json();
};

const days = ["Sun", "Mon", "Tues", "Wed", "Thu", "Fri", "Sat", "Sun"];
const getDayOfWeek = (date) => {
  if (!date) return "";
  const d = new Date(date);
  return days[d.getDay()];
};

const formatDate = (date) => {
  if (!date) return "";
  const d = new Date(date);
  return `${d.getMonth() + 1}/${d.getDate()}`;
};

const formatTime = (time) => {
  if (!time) return "";
  let [hour, min] = time.split(":");
  if (+hour > 12) hour = +hour - 12;
  return `${hour}:${min}`;
};

const start = (json) => {
  const facilities = json.included
    .filter((item) => item.type === "resource")
    .reduce((acc, item) => {
      acc[item.id] = item.attributes.name;
      return acc;
    }, {});

  const teams = json.included
    .filter((item) => item.type === "team")
    .reduce((acc, item) => {
      acc[item.id] = item.attributes.name;
      return acc;
    }, {});

  // Add moose knucks
  teams[json.data.id] = json.data.attributes.name;

  const events = json.included
    .filter(
      (item) => item.type === "event" && item.attributes.event_type !== "L"
    )
    .map((item) => {
      const e = item.attributes;
      return {
        location: facilities[e.resource_id],
        hscore: e.hscore ?? 0,
        vscore: e.vscore ?? 0,
        sub_type: e.sub_type,
        hteam: teams[e.hteam_id] ?? "Home Team",
        vteam: teams[e.vteam_id] ?? "Away Team",
        desc: e.desc,
        start_date: e.start_date,
        start_time: e.event_start_time,
        date_formatted: formatDate(e.start_date),
        time_fomatted: formatTime(e.event_start_time),
        day_of_week: getDayOfWeek(e.start_date)
      };
    })
    .sort((a, b) =>
      a.start_date < b.start_date ? 1 : a.start_date > b.start_date ? -1 : 0
    );

  const app = document.getElementById("app");

  const dom = events.map((event, i) => {
    return `
    <div class="containter flex flex-row my-4 lg:w-1/2 py-5 border-b w-full px-2 lg:px-5">
      <div class="flex flex-row w-full ${i % 2 ? "" : "lg:border-r"}">
        <div class="event flex flex-col w-3/4">
          <div class="away flex items-center justify-between ${
            event.vscore > event.hscore ? "font-bold" : ""
          }">
            <div class="team text-lg">${event.vteam}</div>
            <div class="score text-lg">${event.vscore}</div>
          </div>
          <div class="home flex items-center justify-between ${
            event.hscore > event.vscore ? "font-bold" : ""
          }">
            <div class="team text-lg">${event.hteam}</div>
            <div class="score text-lg">${event.hscore}</div>
          </div>
          <div class="meta flex items-center justify-between mt-2 text-sm text-gray-400 font-light">
            <div class="location">${event.location}</div>
            <div class="timedate">
              ${event.day_of_week} ${event.date_formatted} ${event.time_fomatted}
            </div>
          </div>
        </div>
        <div class="beer flex items-center p-5 w-1/4">
          <div class="text-center w-full">${beerList[event.date_formatted] ?? ""}</div>
        </div>
      </div>
    </div>`;
  });
  app.innerHTML = dom.join("");
};

const beerList = {};
const getSheetData = async () => {
  const response = await fetch(sheetsUrl);
  return await response.text();
};

getSheetData().then((sheet) => {
  const el = document.createElement("div");
  el.innerHTML = sheet;

  [...el.querySelectorAll("tr")].forEach((row) => {
    const td = row.querySelectorAll("td");
    beerList[td[1].textContent] = td[0].textContent;
  });
});

getData().then(start);


  </script>
</body>
</html>
